"""
ìƒë‹´ì› ì‹¤ì  í˜„í™© UI ëª¨ë“ˆ

ì´ ëª¨ë“ˆì€ ìƒë‹´ì› ì‹¤ì  í˜„í™© íƒ­ì˜ UI ìš”ì†Œì™€ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ UIë¥¼ ë¶„ë¦¬í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
"""

import streamlit as st
import pandas as pd
import base64
import plotly.express as px
from datetime import datetime, time
import uuid
from typing import Dict, List, Optional, Any

# ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°€ì ¸ì˜¤ê¸°
from logic.consultant_logic import (
    process_consultant_file, process_calltime_file, 
    analyze_consultant_performance, create_excel_report
)
# CSS ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸°
from styles.consultant_styles import (
    CONSULTANT_TABLE_STYLE, CONSULTANT_SAMPLE_TABLE_STYLE,
    DOWNLOAD_BUTTON_STYLE, DATE_DISPLAY_STYLE,
    CONSULTANT_DESCRIPTION, USAGE_GUIDE_MARKDOWN
)
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ê°€ì ¸ì˜¤ê¸°
from utils.utils import format_time, get_previous_business_day

# ì‹ ì… ëª…ë‹¨ ì •ì˜
NEWBIE_LIST = ['ê°•í•˜ë‚˜', 'êµ¬ì¤€ëª¨', 'ê¹€ì„œìœ¤', 'ì´ë³´ëŒ', 'ì´ì€ê²½']

def calculate_target_calltime_seconds(current_time=None):
    """
    í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ëª©í‘œ ì½œíƒ€ì„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    
    Args:
        current_time: í˜„ì¬ ì‹œê°„ (Noneì¼ ê²½ìš° ì‹¤ì œ í˜„ì¬ ì‹œê°„ ì‚¬ìš©)
        
    Returns:
        int: í˜„ì¬ ì‹œê°„ê¹Œì§€ ëª©í‘œ ì½œíƒ€ì„ (ì´ˆ ë‹¨ìœ„)
    """
    if current_time is None:
        current_time = datetime.now().time()
    
    # ì—…ë¬´ ì‹œê°„ ì •ì˜
    work_start = time(9, 30)  # 9:30 AM
    lunch_start = time(11, 50)  # 11:50 AM
    lunch_end = time(13, 0)  # 1:00 PM
    work_end = time(18, 30)  # 6:30 PM
    
    # ì „ì²´ ëª©í‘œ ì½œíƒ€ì„ (3ì‹œê°„ 30ë¶„ = 210ë¶„ = 12,600ì´ˆ)
    total_target_seconds = 3 * 3600 + 30 * 60
    
    # ì „ì²´ ê·¼ë¬´ ì‹œê°„ (ì ì‹¬ ì‹œê°„ ì œì™¸ = 7ì‹œê°„ 50ë¶„ = 470ë¶„)
    total_work_minutes = ((18 * 60 + 30) - (9 * 60 + 30)) - ((13 * 60) - (11 * 60 + 50))
    
    # ë¶„ ë‹¨ìœ„ë¡œ í˜„ì¬ ê²½ê³¼ ê·¼ë¬´ ì‹œê°„ ê³„ì‚°
    elapsed_minutes = 0
    
    # í˜„ì¬ ì‹œê°„ì´ ì—…ë¬´ ì‹œì‘ ì‹œê°„ ì´ì „ì¸ ê²½ìš°
    if current_time < work_start:
        return 0
    
    # í˜„ì¬ ì‹œê°„ì´ ì—…ë¬´ ì¢…ë£Œ ì‹œê°„ ì´í›„ì¸ ê²½ìš°
    if current_time > work_end:
        return total_target_seconds
    
    # í˜„ì¬ ì‹œê°„ì´ ì˜¤ì „ ì—…ë¬´ ì‹œê°„ì¸ ê²½ìš° (9:30 ~ 11:50)
    if work_start <= current_time < lunch_start:
        elapsed_minutes = (current_time.hour * 60 + current_time.minute) - (work_start.hour * 60 + work_start.minute)
    
    # í˜„ì¬ ì‹œê°„ì´ ì ì‹¬ ì‹œê°„ì¸ ê²½ìš° (11:50 ~ 13:00)
    elif lunch_start <= current_time < lunch_end:
        elapsed_minutes = (lunch_start.hour * 60 + lunch_start.minute) - (work_start.hour * 60 + work_start.minute)
    
    # í˜„ì¬ ì‹œê°„ì´ ì˜¤í›„ ì—…ë¬´ ì‹œê°„ì¸ ê²½ìš° (13:00 ~ 18:30)
    elif lunch_end <= current_time <= work_end:
        morning_minutes = (lunch_start.hour * 60 + lunch_start.minute) - (work_start.hour * 60 + work_start.minute)
        afternoon_minutes = (current_time.hour * 60 + current_time.minute) - (lunch_end.hour * 60 + lunch_end.minute)
        elapsed_minutes = morning_minutes + afternoon_minutes
    
    # í˜„ì¬ ê²½ê³¼ ê·¼ë¬´ ì‹œê°„ ë¹„ìœ¨ì— ë”°ë¼ ëª©í‘œ ì½œíƒ€ì„ ê³„ì‚°
    target_seconds = int((elapsed_minutes / total_work_minutes) * total_target_seconds)
    
    return target_seconds

def get_consultant_status_emoji(calltime_seconds, target_seconds):
    """
    ì½œíƒ€ì„ ë‹¬ì„± ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ì´ëª¨ì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Args:
        calltime_seconds: ìƒë‹´ì›ì˜ í˜„ì¬ ì½œíƒ€ì„ (ì´ˆ ë‹¨ìœ„)
        target_seconds: í˜„ì¬ ì‹œê°„ê¹Œì§€ ëª©í‘œ ì½œíƒ€ì„ (ì´ˆ ë‹¨ìœ„)
        
    Returns:
        str: ìƒíƒœ ì´ëª¨ì§€
    """
    # ë‹¬ì„±ë¥  ê³„ì‚° (%)
    if target_seconds == 0:
        achievement_rate = 100  # ëª©í‘œê°€ 0ì¸ ê²½ìš° (ì—…ë¬´ ì‹œì‘ ì „)
    else:
        achievement_rate = (calltime_seconds / target_seconds) * 100
    
    # ë‹¬ì„±ë¥ ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
    if achievement_rate >= 100:  # 3ì‹œê°„ë°˜ ì´ˆê³¼ ë‹¬ì„±
        return "ğŸš©"  # ë‹¬ì„± ê¹ƒë°œë°œ
    elif achievement_rate <= 71.4:  # 2ì‹œê°„ë°˜ì´í•˜ í˜ì´ìŠ¤
        return "â°"  # ì•ŒëŒì‹œê³„ (ê´€ì‹¬ í•„ìš”)
    else :
        return ""

def classify_consultant_by_team(df):
    """
    ìƒë‹´ì‚¬ë¥¼ íŒ€ë³„ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.
    
    Args:
        df: ìƒë‹´ì› ë°ì´í„°í”„ë ˆì„
        
    Returns:
        tuple: (crm_df, online_df, newbie_df)
    """
    # ë°ì´í„°í”„ë ˆì„ ë³µì‚¬ë³¸ ìƒì„±
    df_copy = df.copy()
    
    # ì‹ ì… ëª…ë‹¨ì— í•´ë‹¹í•˜ëŠ” ìƒë‹´ì‚¬ë“¤ì˜ ì¡°ì§ì„ 'ì‹ ì…íŒŒíŠ¸'ë¡œ ë³€ê²½
    df_copy.loc[df_copy['ìƒë‹´ì‚¬'].isin(NEWBIE_LIST), 'ì¡°ì§'] = 'ì‹ ì…íŒŒíŠ¸'
    
    # íŒ€ë³„ë¡œ ë¶„ë¦¬
    crm_df = df_copy[df_copy['ì¡°ì§'] == 'CRMíŒŒíŠ¸']
    online_df = df_copy[df_copy['ì¡°ì§'] == 'ì˜¨ë¼ì¸íŒŒíŠ¸']
    newbie_df = df_copy[df_copy['ì¡°ì§'] == 'ì‹ ì…íŒŒíŠ¸']
    
    return crm_df, online_df, newbie_df

def generate_team_summary_row(team_df, team_name):
    """
    íŒ€ë³„ ìš”ì•½ í–‰ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        team_df: íŒ€ ë°ì´í„°í”„ë ˆì„
        team_name: íŒ€ ì´ë¦„
        
    Returns:
        dict: ìš”ì•½ ë°ì´í„°
    """
    if len(team_df) == 0:
        return None
        
    summary = {
        "ìˆœìœ„": team_name,
        "ìƒë‹´ì‚¬": "ì´í•©/í‰ê· ",
        "ì•ˆë§ˆì˜ì": team_df["ì•ˆë§ˆì˜ì"].sum(),
        "ë¼í´ë¼ìš°ë“œ": team_df["ë¼í´ë¼ìš°ë“œ"].sum(),
        "ì •ìˆ˜ê¸°": team_df["ì •ìˆ˜ê¸°"].sum(),
        "ë”ì¼€ì–´": team_df["ë”ì¼€ì–´"].sum(),
        "ë©¤ë²„ì‹­": team_df["ë©¤ë²„ì‹­"].sum(),
        "ê±´ìˆ˜": team_df["ê±´ìˆ˜"].sum(),
        "ì½œê±´ìˆ˜": round(team_df["ì½œê±´ìˆ˜"].mean(), 1),
        "ì½œíƒ€ì„": format_time(team_df["ì½œíƒ€ì„_ì´ˆ"].mean())
    }
    return summary

def generate_team_html_rows(team_df, current_target_seconds, total_target_seconds, team_name):
    """
    íŒ€ë³„ HTML í–‰ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        team_df: íŒ€ ë°ì´í„°í”„ë ˆì„
        current_target_seconds: í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ëª©í‘œ ì½œíƒ€ì„
        total_target_seconds: ì „ì²´ ëª©í‘œ ì½œíƒ€ì„
        team_name: íŒ€ ì´ë¦„
        
    Returns:
        str: HTML í–‰ë“¤
    """
    html = ""
    
    if len(team_df) == 0:
        return html
    
    # íŒ€ ë°ì´í„° ì •ë ¬
    sorted_team_df = team_df.sort_values(by=['ê±´ìˆ˜', 'ì½œíƒ€ì„_ì´ˆ'], ascending=[False, False])
    row_num = 1
    
    # ê°œë³„ ìƒë‹´ì‚¬ í–‰ ìƒì„±
    for i, row in sorted_team_df.iterrows():
        is_summary = row['ìƒë‹´ì‚¬'] == 'ì´í•©/í‰ê· '
        row_class = 'summary-row' if is_summary else ''
        
        html += f'<tr class="{row_class}">'
        # ìˆœìœ„ ë¶€ì—¬
        rank = "ì´í•©/í‰ê· " if is_summary else row_num
        html += f'<td>{rank}</td>'
        
        # ìƒë‹´ì‚¬ ì´ë¦„
        html += f'<td>{row["ìƒë‹´ì‚¬"]}</td>'
        
        # ì œí’ˆë³„ ê±´ìˆ˜
        for col in ['ì•ˆë§ˆì˜ì', 'ë¼í´ë¼ìš°ë“œ', 'ì •ìˆ˜ê¸°', 'ë”ì¼€ì–´', 'ë©¤ë²„ì‹­', 'ê±´ìˆ˜']:
            value = row[col]
            value = '-' if value == 0 else value
            html += f'<td>{value}</td>'
        
        # ì½œìˆ˜
        html += f'<td>{row["ì½œê±´ìˆ˜"]}</td>'
        
        # ì½œíƒ€ì„ (í”„ë¡œê·¸ë ˆìŠ¤ ë°” í¬í•¨)
        if not is_summary:
            percentage = min(100, (row["ì½œíƒ€ì„_ì´ˆ"] / total_target_seconds) * 100)
            status_emoji = get_consultant_status_emoji(row["ì½œíƒ€ì„_ì´ˆ"], current_target_seconds)
            html += f'<td class="calltime-cell">{row["ì½œíƒ€ì„"]} {status_emoji}<div class="progress-bar-bg" style="width: {percentage}%;"></div></td>'
        else:
            html += f'<td>{row["ì½œíƒ€ì„"]}</td>'
        
        html += '</tr>'
        
        if not is_summary:
            row_num += 1
    
    # íŒ€ ìš”ì•½ í–‰ ì¶”ê°€
    summary = generate_team_summary_row(team_df, team_name)
    if summary:
        html += '<tr class="summary-row">'
        html += f'<td>{summary["ìˆœìœ„"]}</td>'
        html += f'<td>{summary["ìƒë‹´ì‚¬"]}</td>'
        for col in ['ì•ˆë§ˆì˜ì', 'ë¼í´ë¼ìš°ë“œ', 'ì •ìˆ˜ê¸°', 'ë”ì¼€ì–´', 'ë©¤ë²„ì‹­', 'ê±´ìˆ˜']:
            value = summary[col]
            value = '-' if value == 0 else value
            html += f'<td>{value}</td>'
        html += f'<td>{summary["ì½œê±´ìˆ˜"]}</td>'
        html += f'<td>{summary["ì½œíƒ€ì„"]}</td>'
        html += '</tr>'
    
    return html

def generate_compact_html_table(df: pd.DataFrame, is_previous_day: bool = False):
    """
    ì»´íŒ©íŠ¸í•œ HTML í…Œì´ë¸” ìƒì„± í•¨ìˆ˜ - ì‹ ì…íŒŒíŠ¸ ì¶”ê°€ ë²„ì „
    
    Args:
        df: ìƒë‹´ì› ì‹¤ì  ë°ì´í„°í”„ë ˆì„
        is_previous_day: ì „ë‚  ë°ì´í„° ì¡°íšŒ ì—¬ë¶€
        
    Returns:
        str: HTML í…Œì´ë¸” ì½”ë“œ
    """
    html = CONSULTANT_TABLE_STYLE
    
    # í˜„ì¬ ë‚ ì§œ ë° ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    current_time = datetime.now()
    date_str = f"{current_time.month}ì›”{current_time.day}ì¼({['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][current_time.weekday()]})"
    time_str = f"{current_time.hour}:{current_time.minute:02d}"
    
    # ëª©í‘œ ì½œíƒ€ì„ ê³„ì‚°
    total_target_seconds = 3 * 3600 + 30 * 60  # 3:30:00 = 12600ì´ˆ (ì „ì²´ ëª©í‘œ)
    
    if is_previous_day:
        current_target_seconds = total_target_seconds
    else:
        current_target_seconds = calculate_target_calltime_seconds(current_time.time())
    
    # íŒ€ë³„ ë¶„ë¥˜
    crm_df, online_df, newbie_df = classify_consultant_by_team(df)
    
    # í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì‹œì‘
    html += '<div class="table-container">'
    html += '<table class="compact-table">'
    
    # í—¤ë” ì¶”ê°€
    headers = [
        'ìˆœìœ„', 
        'ìƒë‹´ì‚¬', 
        '<span>ì•ˆë§ˆì˜ì</span>', 
        '<span>ë¼í´ë¼ìš°ë“œ</span>', 
        '<span>ì •ìˆ˜ê¸°</span>', 
        '<span>ë”ì¼€ì–´</span>', 
        '<span>ë©¤ë²„ì‹­</span>', 
        'ê±´ìˆ˜', 
        'ì½œìˆ˜', 
        'ì½œíƒ€ì„'
    ]
    html += '<thead><tr>'
    for header in headers:
        html += f'<th>{header}</th>'
    html += '</tr></thead>'
    
    html += '<tbody>'
    
    # CRM íŒŒíŠ¸ ì²˜ë¦¬
    html += generate_team_html_rows(crm_df, current_target_seconds, total_target_seconds, "CRMíŒ€")
    
    # ì˜¨ë¼ì¸ íŒŒíŠ¸ ì²˜ë¦¬
    html += generate_team_html_rows(online_df, current_target_seconds, total_target_seconds, "ì˜¨ë¼ì¸íŒ€")
    
    # ì‹ ì… íŒŒíŠ¸ ì²˜ë¦¬
    html += generate_team_html_rows(newbie_df, current_target_seconds, total_target_seconds, "ì‹ ì…íŒ€")
    
    html += '</tbody></table>'
    
    # ìš”ì•½ í…ìŠ¤íŠ¸ ë°•ìŠ¤ ìƒì„±
    crm_total = crm_df['ê±´ìˆ˜'].sum() if not crm_df.empty else 0
    online_total = online_df['ê±´ìˆ˜'].sum() if not online_df.empty else 0
    newbie_total = newbie_df['ê±´ìˆ˜'].sum() if not newbie_df.empty else 0
    
    # ì œí’ˆë³„ í•©ê³„
    total_anma = df['ì•ˆë§ˆì˜ì'].sum()
    total_lacloud = df['ë¼í´ë¼ìš°ë“œ'].sum()
    total_water = df['ì •ìˆ˜ê¸°'].sum()
    total_thecare = df['ë”ì¼€ì–´'].sum()
    total_membership = df['ë©¤ë²„ì‹­'].sum()
    grand_total = crm_total + online_total + newbie_total
    
    # íŒ€ë³„ ìƒì„¸ ì •ë³´ ìƒì„±
    def get_team_details(team_df):
        if team_df.empty:
            return "(0ê±´)"
        
        parts = []
        for product, korean_name in [('ì•ˆë§ˆì˜ì', 'ì•ˆë§ˆ'), ('ë¼í´ë¼ìš°ë“œ', 'ë¼í´'), 
                                   ('ì •ìˆ˜ê¸°', 'ì •ìˆ˜ê¸°'), ('ë”ì¼€ì–´', 'ë”ì¼€ì–´'), ('ë©¤ë²„ì‹­', 'ë©¤ë²„ì‰½')]:
            count = team_df[product].sum()
            if count > 0:
                parts.append(f"{korean_name} {count}ê±´")
        
        return f"({', '.join(parts)})" if parts else "(0ê±´)"
    
    crm_details = get_team_details(crm_df)
    online_details = get_team_details(online_df)
    newbie_details = get_team_details(newbie_df)
    
    # ì œí’ˆë³„ í‘œì‹œ (0ê±´ ì œì™¸)
    product_items = []
    if total_anma > 0:
        product_items.append(f'<div class="summary-textbox-product">ğŸ’† ì•ˆë§ˆì˜ì {total_anma}ê±´</div>')
    if total_lacloud > 0:
        product_items.append(f'<div class="summary-textbox-product">ğŸ›ï¸ ë¼í´ë¼ìš°ë“œ {total_lacloud}ê±´</div>')
    if total_water > 0:
        product_items.append(f'<div class="summary-textbox-product">ğŸ’§ ì •ìˆ˜ê¸° {total_water}ê±´</div>')
    if total_thecare > 0:
        product_items.append(f'<div class="summary-textbox-product">ğŸ› ï¸ ë”ì¼€ì–´ {total_thecare}ê±´</div>')
    if total_membership > 0:
        product_items.append(f'<div class="summary-textbox-product">ğŸ”– ë©¤ë²„ì‰½ {total_membership}ê±´</div>')
    
    product_html = '\n'.join(product_items)
    
    # í˜„ì¬ ëª©í‘œ ì‹œê°„ í‘œì‹œ
    current_target_time = format_time(current_target_seconds)
    
    # ìš”ì•½ í…ìŠ¤íŠ¸ ë°•ìŠ¤ HTML
    html += f'''
    <div class="summary-textbox">
        <div class="summary-textbox-title">{date_str} CRMíŒ€ ì‹¤ì _{time_str}</div>
        <br>
        <div class="summary-textbox-team">ğŸ”„ CRMíŒ€ : ì´ {crm_total}ê±´</div>
        <div>{crm_details}</div>
        <div class="summary-textbox-team">ğŸ’» ì˜¨ë¼ì¸íŒ€: ì´ {online_total}ê±´</div>
        <div>{online_details}</div>
        <div class="summary-textbox-team">ğŸŒ± ì‹ ì…íŒ€: ì´ {newbie_total}ê±´</div>
        <div>{newbie_details}</div>
        <br>
        {product_html}
        <br>
        <div class="summary-textbox-total">ğŸ“Š ì´ ê±´ìˆ˜ {grand_total}ê±´</div>
        <div class="summary-textbox-info">â±ï¸ í˜„ì¬ ëª©í‘œ ì‹œê°„: {current_target_time}</div>
        <div class="summary-textbox-legend">
            <span class="legend-item">ğŸš©: ëª©í‘œ ë‹¬ì„±</span>
            <span class="legend-item">â°: ë¶„ë°œí•„ìš”</span>
        </div>
    </div>
    '''
    
    html += '</div>'  # í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ë‹«ê¸°
    return html

def generate_compact_sample_html_table() -> str:
    """
    ìƒ˜í”Œ HTML í…Œì´ë¸” ìƒì„± í•¨ìˆ˜ - ì‹ ì…íŒŒíŠ¸ ì¶”ê°€ ë²„ì „
    
    Returns:
        str: ìƒ˜í”Œ HTML í…Œì´ë¸” ì½”ë“œ
    """
    html = CONSULTANT_TABLE_STYLE
    
    # í˜„ì¬ ë‚ ì§œ ë° ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    current_time = datetime.now()
    date_str = f"{current_time.month}ì›”{current_time.day}ì¼({['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][current_time.weekday()]})"
    time_str = f"{current_time.hour}:{current_time.minute:02d}"
    
    # 10ì‹œ 30ë¶„ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ ë°©ì‹ ê²°ì •
    cutoff_time = current_time.replace(hour=10, minute=30, second=0, microsecond=0)
    is_previous_day = current_time < cutoff_time
    
    # ëª©í‘œ ì½œíƒ€ì„ ê³„ì‚°
    total_target_seconds = 3 * 3600 + 30 * 60  # 3:30:00 = 12600ì´ˆ (ì „ì²´ ëª©í‘œ)
    
    if is_previous_day:
        current_target_seconds = total_target_seconds
        current_target_time = "3:30:00"
    else:
        current_target_seconds = calculate_target_calltime_seconds(current_time.time())
        current_target_time = format_time(current_target_seconds)
    
    # í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì‹œì‘
    html += '<div class="table-container">'
    html += '<table class="compact-table">'
    
    # í—¤ë” ì¶”ê°€
    headers = ['ìˆœìœ„', 'ìƒë‹´ì‚¬', '<span>ì•ˆë§ˆì˜ì</span>', '<span>ë¼í´ë¼ìš°ë“œ</span>', '<span>ì •ìˆ˜ê¸°</span>', '<span>ë”ì¼€ì–´</span>', '<span>ë©¤ë²„ì‹­</span>', 'ê±´ìˆ˜', 'ì½œìˆ˜', 'ì½œíƒ€ì„']
    html += '<thead><tr>'
    for header in headers:
        html += f'<th>{header}</th>'
    html += '</tr></thead>'
    
    # ê° ì‹œê°„ ë¬¸ìì—´ì„ ì´ˆë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    def time_to_seconds(time_str):
        parts = time_str.split(':')
        if len(parts) == 3:
            h, m, s = map(int, parts)
            return h * 3600 + m * 60 + s
        return 0
    
    html += '<tbody>'
    
    # CRM íŒŒíŠ¸ ìƒ˜í”Œ ë°ì´í„°
    crm_data = [
        [1, 'ì´ìŠ¹í˜„', '-', '-', 5, 5, '-', 5, 55, '2:34:18'],
        [2, 'ìœ íƒœê²½', '-', '-', 4, 4, '-', 4, 91, '1:50:16'],
        [3, 'ì„ëª…ìˆ™', '-', '-', 3, 3, '-', 3, 91, '2:49:10'],
        [4, 'ì„ëª…ìˆ™', '-', '-', 3, 3, '-', 3, 217, '2:33:39'],
        [5, 'ê¹€ë¯¸ì •', '-', '-', 3, 3, '-', 3, 247, '2:19:56'],
        ['CRMíŒ€', 'ì´í•©/í‰ê· ', 1, 1, 32, 34, 1, 34, 134, '2:18:39']
    ]
    
    for row in crm_data:
        is_summary = row[0] == 'CRMíŒ€'
        row_class = 'summary-row' if is_summary else ''
        html += f'<tr class="{row_class}">'
        
        html += f'<td>{row[0]}</td>'
        html += f'<td>{row[1]}</td>'
        
        for i in range(2, 9):
            html += f'<td>{row[i]}</td>'
        
        if not is_summary:
            call_time = row[9]
            seconds = time_to_seconds(call_time)
            percentage = min(100, (seconds / total_target_seconds) * 100)
            status_emoji = get_consultant_status_emoji(seconds, current_target_seconds)
            html += f'<td class="calltime-cell">{call_time} {status_emoji}<div class="progress-bar-bg" style="width: {percentage}%;"></div></td>'
        else:
            html += f'<td>{row[9]}</td>'
        
        html += '</tr>'
    
    # ì˜¨ë¼ì¸ íŒŒíŠ¸ ìƒ˜í”Œ ë°ì´í„°
    online_data = [
        [1, 'ê¹€ë¶€ì', 2, '-', '-', 1, '-', 3, 60, '2:37:15'],
        [2, 'ìµœì§„ì˜', 1, '-', '-', 1, '-', 2, 59, '1:44:40'],
        ['ì˜¨ë¼ì¸íŒ€', 'ì´í•©/í‰ê· ', 3, '-', '-', 2, '-', 5, 59, '2:10:58']
    ]
    
    for row in online_data:
        is_summary = row[0] == 'ì˜¨ë¼ì¸íŒ€'
        row_class = 'summary-row' if is_summary else ''
        html += f'<tr class="{row_class}">'
        
        html += f'<td>{row[0]}</td>'
        html += f'<td>{row[1]}</td>'
        
        for i in range(2, 9):
            html += f'<td>{row[i]}</td>'
        
        if not is_summary:
            call_time = row[9]
            seconds = time_to_seconds(call_time)
            percentage = min(100, (seconds / total_target_seconds) * 100)
            status_emoji = get_consultant_status_emoji(seconds, current_target_seconds)
            html += f'<td class="calltime-cell">{call_time} {status_emoji}<div class="progress-bar-bg" style="width: {percentage}%;"></div></td>'
        else:
            html += f'<td>{row[9]}</td>'
        
        html += '</tr>'
    
    # ì‹ ì… íŒŒíŠ¸ ìƒ˜í”Œ ë°ì´í„°
    newbie_data = [
        [1, 'ê°•í•˜ë‚˜', '-', '-', 2, '-', '-', 2, 45, '1:30:25'],
        [2, 'êµ¬ì¤€ëª¨', '-', '-', 1, 1, '-', 2, 38, '1:15:30'],
        [3, 'ê¹€ì„œìœ¤', '-', '-', 1, '-', '-', 1, 42, '1:05:15'],
        ['ì‹ ì…íŒ€', 'ì´í•©/í‰ê· ', '-', '-', 4, 1, '-', 5, 42, '1:17:03']
    ]
    
    for row in newbie_data:
        is_summary = row[0] == 'ì‹ ì…íŒ€'
        row_class = 'summary-row' if is_summary else ''
        html += f'<tr class="{row_class}">'
        
        html += f'<td>{row[0]}</td>'
        html += f'<td>{row[1]}</td>'
        
        for i in range(2, 9):
            html += f'<td>{row[i]}</td>'
        
        if not is_summary:
            call_time = row[9]
            seconds = time_to_seconds(call_time)
            percentage = min(100, (seconds / total_target_seconds) * 100)
            status_emoji = get_consultant_status_emoji(seconds, current_target_seconds)
            html += f'<td class="calltime-cell">{call_time} {status_emoji}<div class="progress-bar-bg" style="width: {percentage}%;"></div></td>'
        else:
            html += f'<td>{row[9]}</td>'
        
        html += '</tr>'
            
    html += '</tbody></table>'
    
    # ìš”ì•½ í…ìŠ¤íŠ¸ ë°•ìŠ¤ ì¶”ê°€ (ìƒ˜í”Œ ë°ì´í„° ì§ì ‘ í•˜ë“œì½”ë”©)
    html += f'''
    <div class="summary-textbox">
        <div class="summary-textbox-title">{date_str} CRMíŒ€ ì‹¤ì _{time_str}</div>
        <br>
        <div class="summary-textbox-team">ğŸ”„ CRMíŒ€ : ì´ 30ê±´</div>
        <div>(ì•ˆë§ˆ 1ê±´, ë¼í´ 3ê±´, ì •ìˆ˜ê¸° 24ê±´, ë”ì¼€ì–´ 1ê±´, ë©¤ë²„ì‰½ 1ê±´)</div>
        <div class="summary-textbox-team">ğŸ’» ì˜¨ë¼ì¸íŒ€: ì´ 9ê±´</div>
        <div>(ì•ˆë§ˆ 5ê±´, ë¼í´ 3ê±´, ì •ìˆ˜ê¸° 1ê±´)</div>
        <div class="summary-textbox-team">ğŸŒ± ì‹ ì…íŒ€: ì´ 5ê±´</div>
        <div>(ì •ìˆ˜ê¸° 4ê±´, ë”ì¼€ì–´ 1ê±´)</div>
        <br>
        <div class="summary-textbox-product">ğŸ’† ì•ˆë§ˆì˜ì 6ê±´</div>
        <div class="summary-textbox-product">ğŸ›ï¸ ë¼í´ë¼ìš°ë“œ 6ê±´</div>
        <div class="summary-textbox-product">ğŸ’§ ì •ìˆ˜ê¸° 29ê±´</div>
        <div class="summary-textbox-product">ğŸ› ï¸ ë”ì¼€ì–´ 2ê±´</div>
        <div class="summary-textbox-product">ğŸ”– ë©¤ë²„ì‰½ 1ê±´</div>
        <br>
        <div class="summary-textbox-total">ğŸ“Š ì´ ê±´ìˆ˜ 44ê±´</div>
        <div class="summary-textbox-info">â±ï¸ í˜„ì¬ ëª©í‘œ ì‹œê°„: {current_target_time}</div>
        <div class="summary-textbox-legend">
            <span class="legend-item">ğŸš©: ëª©í‘œ ë‹¬ì„±</span>
            <span class="legend-item">â°: ëª©í‘œ ë¯¸ë‹¬</span>
        </div>
    </div>
    '''
    
    html += '</div>'  # í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ë‹«ê¸°
    return html
        

def create_compact_visualization(performance_df: pd.DataFrame):
    """
    íŒ€ë³„ ë¹„êµ ì‹œê°í™”ë¥¼ ìœ„í•œ ì»´íŒ©íŠ¸í•œ ì°¨íŠ¸ ìƒì„± - ì‹ ì…íŒŒíŠ¸ ì¶”ê°€ ë²„ì „
    
    Args:
        performance_df: ìƒë‹´ì› ì‹¤ì  ë°ì´í„°í”„ë ˆì„
        
    Returns:
        plotly.Figure: ì‹œê°í™” ì°¨íŠ¸
    """
    import plotly.graph_objects as go
    import pandas as pd
    import plotly.express as px
    
    # íŒ€ë³„ ë¶„ë¥˜
    crm_df, online_df, newbie_df = classify_consultant_by_team(performance_df)
    
    # íŒ€ë³„ ìš”ì•½ ë°ì´í„° ìƒì„±
    team_summary_data = []
    
    # CRMíŒ€ ìš”ì•½
    if not crm_df.empty:
        team_summary_data.append({
            "ì¡°ì§": "CRMíŒ€",
            "ì•ˆë§ˆì˜ì": crm_df["ì•ˆë§ˆì˜ì"].sum(),
            "ë¼í´ë¼ìš°ë“œ": crm_df["ë¼í´ë¼ìš°ë“œ"].sum(),
            "ì •ìˆ˜ê¸°": crm_df["ì •ìˆ˜ê¸°"].sum(),
            "ë”ì¼€ì–´": crm_df["ë”ì¼€ì–´"].sum(),
            "ë©¤ë²„ì‹­": crm_df["ë©¤ë²„ì‹­"].sum(),
            "ì´ê±´ìˆ˜": crm_df["ê±´ìˆ˜"].sum()
        })
    
    # ì˜¨ë¼ì¸íŒ€ ìš”ì•½
    if not online_df.empty:
        team_summary_data.append({
            "ì¡°ì§": "ì˜¨ë¼ì¸íŒ€",
            "ì•ˆë§ˆì˜ì": online_df["ì•ˆë§ˆì˜ì"].sum(),
            "ë¼í´ë¼ìš°ë“œ": online_df["ë¼í´ë¼ìš°ë“œ"].sum(),
            "ì •ìˆ˜ê¸°": online_df["ì •ìˆ˜ê¸°"].sum(),
            "ë”ì¼€ì–´": online_df["ë”ì¼€ì–´"].sum(),
            "ë©¤ë²„ì‹­": online_df["ë©¤ë²„ì‹­"].sum(),
            "ì´ê±´ìˆ˜": online_df["ê±´ìˆ˜"].sum()
        })
    
    # ì‹ ì…íŒ€ ìš”ì•½
    if not newbie_df.empty:
        team_summary_data.append({
            "ì¡°ì§": "ì‹ ì…íŒ€",
            "ì•ˆë§ˆì˜ì": newbie_df["ì•ˆë§ˆì˜ì"].sum(),
            "ë¼í´ë¼ìš°ë“œ": newbie_df["ë¼í´ë¼ìš°ë“œ"].sum(),
            "ì •ìˆ˜ê¸°": newbie_df["ì •ìˆ˜ê¸°"].sum(),
            "ë”ì¼€ì–´": newbie_df["ë”ì¼€ì–´"].sum(),
            "ë©¤ë²„ì‹­": newbie_df["ë©¤ë²„ì‹­"].sum(),
            "ì´ê±´ìˆ˜": newbie_df["ê±´ìˆ˜"].sum()
        })
    
    team_summary = pd.DataFrame(team_summary_data)
    
    # ìƒ‰ìƒ ì„¤ì •
    colors = {
        "ì•ˆë§ˆì˜ì": "#66c2a5",
        "ë¼í´ë¼ìš°ë“œ": "#fcfc99",
        "ì •ìˆ˜ê¸°": "#8da0cb",
        "ë”ì¼€ì–´": "#fc8d62",
        "ë©¤ë²„ì‹­": "#80b1d3",
        "ì´ê±´ìˆ˜": "#4472C4"
    }
    
    # íŒ€ë³„ ë°ì´í„° ì •ë¦¬ (0ê±´ ì œì™¸)
    plot_data = []
    
    for _, team_row in team_summary.iterrows():
        team_name = team_row["ì¡°ì§"]
        for product in ["ì•ˆë§ˆì˜ì", "ë¼í´ë¼ìš°ë“œ", "ì •ìˆ˜ê¸°", "ë”ì¼€ì–´", "ë©¤ë²„ì‹­", "ì´ê±´ìˆ˜"]:
            value = team_row[product]
            if product == "ì´ê±´ìˆ˜" or value > 0:  # ì´ê±´ìˆ˜ëŠ” í•­ìƒ í¬í•¨, ë‚˜ë¨¸ì§€ëŠ” 0ê±´ ì œì™¸
                plot_data.append({
                    "íŒ€": team_name,
                    "ì œí’ˆ": product,
                    "ê±´ìˆ˜": value
                })
    
    plot_df = pd.DataFrame(plot_data)
    
    # ì œí’ˆ ìœ í˜• ìˆœì„œ ì§€ì •
    category_order = ["ì•ˆë§ˆì˜ì", "ë¼í´ë¼ìš°ë“œ", "ì •ìˆ˜ê¸°", "ë”ì¼€ì–´", "ë©¤ë²„ì‹­", "ì´ê±´ìˆ˜"]
    
    # Plotly Expressë¡œ ê·¸ë˜í”„ ìƒì„±
    fig = px.bar(
        plot_df,
        x="íŒ€",
        y="ê±´ìˆ˜",
        color="ì œí’ˆ",
        barmode="group",
        color_discrete_map=colors,
        category_orders={"ì œí’ˆ": category_order},
        text="ê±´ìˆ˜",
        title="íŒ€ë³„ ì œí’ˆ ìœ í˜• ë° ì´ê±´ìˆ˜ ë¹„êµ (ì‹ ì…íŒ€ í¬í•¨)"
    )
    
    # ì´ê±´ìˆ˜ ë§‰ëŒ€ ê°•ì¡°
    for trace in fig.data:
        if trace.name == "ì´ê±´ìˆ˜":
            trace.marker.line.width = 1.5
            trace.marker.line.color = "black"
    
    # ë ˆì´ì•„ì›ƒ ì„¤ì •
    fig.update_layout(
        height=350,
        margin=dict(l=40, r=40, t=60, b=40),
        legend=dict(
            orientation="h",
            yanchor="bottom",
            y=1.02,
            xanchor="right",
            x=1,
            font=dict(size=10)
        ),
        font=dict(size=10),
        plot_bgcolor="rgba(240, 240, 240, 0.2)",
        paper_bgcolor="rgba(0, 0, 0, 0)",
        yaxis=dict(
            showgrid=True,
            gridwidth=1,
            gridcolor="rgba(211, 211, 211, 0.3)"
        ),
        xaxis=dict(
            showgrid=False
        )
    )
    
    # ìŠ¤íƒ€ì¼ ê°œì„ 
    fig.update_traces(
        textposition='outside',
        textfont_size=9,
        width=0.7
    )
    
    # ë¹ˆ ê³µê°„ ìµœì†Œí™”
    fig.update_layout(
        bargap=0.2,
        bargroupgap=0.02
    )
    
    return fig

def show():
    """ìƒë‹´ì› ì‹¤ì  í˜„í™© íƒ­ UIë¥¼ í‘œì‹œí•˜ëŠ” ë©”ì¸ í•¨ìˆ˜"""
    
    # íƒ€ì´í‹€ ë° ì„¤ëª…
    st.title("ğŸ‘¥ìƒë‹´ì› ì‹¤ì  í˜„í™©")
    st.markdown(CONSULTANT_DESCRIPTION, unsafe_allow_html=True)
    
    # ì¶”ê°€ ìŠ¤íƒ€ì¼ ì ìš©
    st.markdown("""
    <style>
    .summary-textbox-info {
        margin-top: 10px;
        font-weight: 700;
        color: #1976d2;
    }
    .summary-textbox-legend {
        margin-top: 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 0.75em;
    }
    .legend-item {
        background-color: #2c5aa0;
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        white-space: nowrap;
        font-weight: 500;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .dark-theme .summary-textbox-info {
        color: #4f96e6;
    }
    .dark-theme .legend-item {
        background-color: #3a3a3a;
        color: #ffffff;
    }
    
    .simple-legend {
        text-align: center;
        margin-top: 2px;
        margin-bottom: 5px;
        font-size: 0.9em;
        font-weight: 500;
        background-color: #2c5aa0;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if 'consultant_df' not in st.session_state:
        st.session_state.consultant_df = None
    if 'calltime_df' not in st.session_state:
        st.session_state.calltime_df = None
    if 'performance_df' not in st.session_state:
        st.session_state.performance_df = None
    if 'filtered_data' not in st.session_state:
        st.session_state.filtered_data = None
    
    # íŒŒì¼ ì—…ë¡œë“œ UI
    st.subheader("ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ìƒë‹´ì£¼ë¬¸ê³„ì•½ë‚´ì—­ ì²¨ë¶€")
        consultant_file = st.file_uploader("ìƒë‹´ì£¼ë¬¸ê³„ì•½ë‚´ì—­ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=['xlsx', 'xls'], key="consultant_file")
    
    with col2:
        st.markdown("### ì½œíƒ€ì„ ì²¨ë¶€")
        calltime_file = st.file_uploader("ì½œíƒ€ì„ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=['xlsx', 'xls'], key="calltime_file")
    
    # ë©”ì¸ ë¡œì§
    if consultant_file is not None and calltime_file is not None:
        # íŒŒì¼ ì²˜ë¦¬ ì§„í–‰ ìƒíƒœ í‘œì‹œ
        with st.spinner('íŒŒì¼ ì²˜ë¦¬ ì¤‘...'):
            # íŒŒì¼ ìœ„ì¹˜ ì €ì¥ì„ ìœ„í•´ seek(0)
            consultant_file.seek(0)
            calltime_file.seek(0)
            
            # íŒŒì¼ ì²˜ë¦¬ ì‹œë„
            consultant_df, consultant_error = process_consultant_file(consultant_file)
            calltime_df, calltime_error = process_calltime_file(calltime_file)
        
        # ì˜¤ë¥˜ ì²´í¬
        if consultant_error:
            st.error(consultant_error)
        elif calltime_error:
            st.error(calltime_error)
        else:
            # ì„¸ì…˜ ìƒíƒœì— ë°ì´í„°í”„ë ˆì„ ì €ì¥
            st.session_state.consultant_df = consultant_df
            st.session_state.calltime_df = calltime_df
            
            # ë¶„ì„ ì‹¤í–‰
            performance_df, filtered_data, analysis_error = analyze_consultant_performance(consultant_df, calltime_df)
            
            if analysis_error:
                st.error(analysis_error)
            else:
                # ì„¸ì…˜ ìƒíƒœì— ê²°ê³¼ ì €ì¥
                st.session_state.performance_df = performance_df
                st.session_state.filtered_data = filtered_data
                
                # ê²°ê³¼ í‘œì‹œ
                st.markdown('<h3>ìƒë‹´ì› ì‹¤ì  í˜„í™©</h3>', unsafe_allow_html=True)
                
                # í•„í„°ë§ëœ ë°ì´í„° ì •ë³´ í‘œì‹œ
                if filtered_data is not None:
                    st.write(f"í•„í„°ë§ëœ ì›ë³¸ ë°ì´í„°: {len(filtered_data)}ê°œì˜ í–‰, íŒë§¤ì±„ë„ì´ 'ë³¸ì‚¬' ë˜ëŠ” 'ì˜¨ë¼ì¸'ì¸ ë°ì´í„°ë§Œ í¬í•¨")

                # í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
                current_time = datetime.now()
                cutoff_time = current_time.replace(hour=10, minute=30, second=0, microsecond=0)

                # ëª©í‘œ ì‹œê°„ ë° ì´ëª¨ì§€ ê¸°ì¤€ ì„¤ì •
                if current_time < cutoff_time:
                    is_previous_day = True
                    current_target_time = "3:30:00"
                    prev_date = get_previous_business_day(current_time)
                    date_display = f"â˜…ì „ìê³„ì•½ ì œì™¸â˜… &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {prev_date.year}ë…„ {prev_date.month}ì›” {prev_date.day}ì¼ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì „ì²´ì§‘ê³„"
                else:
                    is_previous_day = False
                    current_target_seconds = calculate_target_calltime_seconds(current_time.time())
                    current_target_time = format_time(current_target_seconds)
                    date_display = f"â˜…ì „ìê³„ì•½ ì œì™¸â˜… &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {current_time.year}ë…„ {current_time.month}ì›” {current_time.day}ì¼ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {current_time.hour}ì‹œ{current_time.minute}ë¶„ ê¸°ì¤€"

                # ìƒíƒœ í‘œì‹œ
                st.markdown(f'<div class="status-container"><div class="status-chip success">ë¶„ì„ ì™„ë£Œ</div><div class="timestamp">{current_time.strftime("%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„")} ê¸°ì¤€ | í˜„ì¬ ëª©í‘œ ì½œíƒ€ì„: {current_target_time}</div></div>', unsafe_allow_html=True)

                # ë°ì´í„° ì •ë³´ í‘œì‹œ (ì‹ ì… í¬í•¨)
                crm_df, online_df, newbie_df = classify_consultant_by_team(performance_df)
                st.write(f"ì´ {len(performance_df)}ëª…ì˜ ìƒë‹´ì› ì‹¤ì ì´ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤. (CRM: {len(crm_df)}ëª…, ì˜¨ë¼ì¸: {len(online_df)}ëª…, ì‹ ì…: {len(newbie_df)}ëª…)")

                # ë‚ ì§œ í‘œì‹œ
                st.markdown(DATE_DISPLAY_STYLE.format(date_display=date_display), unsafe_allow_html=True)
                
                # ë²”ë¡€ í‘œì‹œ
                st.markdown(f'<div class="simple-legend">â±ï¸ ëª©í‘œì‹œê°„: {current_target_time} | ğŸš©:ë‹¬ì„± | â°:ë¶„ë°œí•„ìš”</div>', unsafe_allow_html=True)

                # ì»´íŒ©íŠ¸ HTML í…Œì´ë¸” ìƒì„± ë° í‘œì‹œ
                html_table = generate_compact_html_table(performance_df, is_previous_day)
                st.markdown(html_table, unsafe_allow_html=True)
                
                # ì‹œê°í™” ì„¹ì…˜
                with st.expander("ì‹œê°í™” ë³´ê¸°", expanded=False):
                    st.plotly_chart(create_compact_visualization(performance_df), use_container_width=True)
                
                # ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                st.markdown("### ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ")
                st.markdown(DOWNLOAD_BUTTON_STYLE, unsafe_allow_html=True)

                try:
                    # í˜„ì¬ ë‚ ì§œì™€ UUID ìƒì„±
                    today = datetime.now().strftime('%Y%m%d')
                    unique_id = str(uuid.uuid4())[:4]
                    file_prefix = f"{today}_{unique_id}_"
                    
                    # ì—‘ì…€ íŒŒì¼ ìƒì„±
                    excel_data = create_excel_report(performance_df, filtered_data)
                    
                    if excel_data:
                        sheet_count = "2ì‹œíŠ¸" if filtered_data is not None else "1ì‹œíŠ¸"
                        b64 = base64.b64encode(excel_data).decode()
                        href = f'<div class="download-button-container"><a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{b64}" download="{file_prefix}ìƒë‹´ì›_ì‹¤ì _í˜„í™©.xlsx" class="download-button">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ({sheet_count})</a></div>'
                        st.markdown(href, unsafe_allow_html=True)
                    else:
                        st.error("ì—‘ì…€ íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                except Exception as e:
                    st.error(f"ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
    else:
        # íŒŒì¼ ì—…ë¡œë“œ ì „ ì•ˆë‚´ í™”ë©´
        st.info("ìƒë‹´ì£¼ë¬¸ê³„ì•½ë‚´ì—­ê³¼ ì½œíƒ€ì„ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")
        
        # ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
        st.markdown("### í‘œì‹œ í˜•ì‹ ìƒ˜í”Œ")
        
        # í˜„ì¬ ë‚ ì§œ ë° ì‹œê°„ í‘œì‹œ ì¶”ê°€ (ìƒ˜í”Œì—ë„ ì ìš©)
        current_time = datetime.now()
        cutoff_time = current_time.replace(hour=10, minute=30, second=0, microsecond=0)
        
        if current_time < cutoff_time:
            current_target_time = "3:30:00"
            prev_date = get_previous_business_day(current_time)
            date_display = f"â˜…ì „ìê³„ì•½ ì œì™¸â˜… &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {prev_date.year}ë…„ {prev_date.month}ì›” {prev_date.day}ì¼ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ì „ì²´ì§‘ê³„"
        else:
            current_target_seconds = calculate_target_calltime_seconds(current_time.time())
            current_target_time = format_time(current_target_seconds)
            date_display = f"â˜…ì „ìê³„ì•½ ì œì™¸â˜… &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {current_time.year}ë…„ {current_time.month}ì›” {current_time.day}ì¼ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {current_time.hour}ì‹œ{current_time.minute}ë¶„ ê¸°ì¤€"
        
        st.markdown(DATE_DISPLAY_STYLE.format(date_display=date_display), unsafe_allow_html=True)
        
        # ë²”ë¡€ í‘œì‹œ
        st.markdown(f'<div class="simple-legend">â±ï¸ ëª©í‘œì‹œê°„: {current_target_time} |  ğŸš©:ë‹¬ì„± | â°:ë¶„ë°œí•„ìš”</div>', unsafe_allow_html=True)
        
        # ì»´íŒ©íŠ¸ ìƒ˜í”Œ í…Œì´ë¸” í‘œì‹œ (ì‹ ì… í¬í•¨)
        html_table = generate_compact_sample_html_table()
        st.markdown(html_table, unsafe_allow_html=True)
        
        # ê°„ì†Œí™”ëœ ì‚¬ìš© ê°€ì´ë“œ
        st.markdown(USAGE_GUIDE_MARKDOWN, unsafe_allow_html=True)
